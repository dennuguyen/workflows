name: Autograding Tests

on:
  push:
    branches:
      main

permissions:
  checks: write
  actions: read
  contents: read

jobs:
  run-autograding-tests:
    runs-on: ubuntu-latest
    if: github.actor != 'github-classroom[bot]'
    # services:
    #   gtest:
    #     image: docker://srzzumix/googletest:latest
    #   webots:
    #     image: cyberbotics/webots:latest
    steps:
    - name: Install gtest
      uses: MarkusJx/googletest-installer@v1.1
    - name: Create workspace
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
    - name: Checkout test code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0
        repository: UNSW-MTRN2500/webots-utils
        path: temp
    - name: Copy test code into workspace
      uses: ./.github/actions/copy-files
      with:
        mapping: |
          temp/protos/lab7/epuck.proto: protos/epuck.proto
          temp/protos/lab7/ds.proto: protos/ds.proto
    # - name: Starting up Webots simulation...
    #   uses: ./.github/actions/run-webots
    #   timeout-minutes: 1
    #   with:
    #     world: "worlds/arena.wbt"
    - name: Install Cmake
      uses: lukka/get-cmake@latest
    - name: Create build directory
      run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
    - name: Setup Python environment
      uses: actions/setup-python@v6
      with:
        python-version: 3.13
        cache: pip
    - name: Install Python dependencies
      shell: bash
      run: |
        pip install -r ./.github/actions/run-gtest/requirements.txt
        pip install -r ./.github/actions/report-grade/requirements.txt
    - name: Test Stage 1
      id: stage-1
      uses: ./.github/actions/run-gtest
      with:
        target: test_stage1
    - name: Test Stage 2
      id: stage-2
      uses: ./.github/actions/run-gtest
      with:
        target: test_stage2
    - name: Final grade
      uses: ./.github/actions/report-grade
      with:
        results: |
          "${{steps.stage-1.outputs.result}}"
          "${{steps.stage-2.outputs.result}}"